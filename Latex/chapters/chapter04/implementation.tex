%
% File: chap01.tex
% Author: Liam O'Shea
% Description: Introduction chapter where the boxing goes.
%
\let\textcircled=\pgftextcircled
\chapter{Implementation}
\label{chap:intro}

\initial{B}egging implementation chapter. How the hell do I start this. What even goes here.

%=======
\section{Comparison Methods}
\label{sec:sec01}


I began by plotting the initial Kinect Data over time in an attempt to understand \& visualise the nature of the data. I differentiated the data as a method of smoothing and to get the velocity data from distance.


\begin{figure}[t!]
\centering
\begin{minipage}{6.0cm}
    \centering
    \subtop[]{\includegraphics[height=0.25\textheight]{fig04/fig06}}
    \label{fig:1}
\end{minipage}
\begin{minipage}{6.0cm}
    \centering
    \subtop[]{\includegraphics[height=0.25\textheight]{fig04/fig07}}
    \label{fig:2}
\end{minipage}
\mycaption[ALLData] {(a) Kinect Skeleton vs Time. 
(b) Hip Joint vs Time, Blue = Raw data, Green = Differentiated data.}
\end{figure}

After recording a punch sequence my first inclination was to look at the left hand (jab) over time. I plotted the z co-ordinate of the left wrist joint over each frame which produced a periodic pattern for which looked promising.


\begin{figure}[h]
    \centering
    \includegraphics[height=0.25\textheight]{fig04/fig01}
    \mycaption[Kinect Device]{Depth of left wrist joint over time}
    \label{fig:kinect}
\end{figure}



My next step was to look at  punch segmentation. Due the cyclical nature of the punch movement I needed to develop a method for segmenting the punches. I decided the best way to do this was to smooth the signal and use local maxima/minima as a means of successfully segmenting the beginning and end of each punch. As you can see from Figure 4.2 some smoothing was required due to local maxima/minima which did not signify the beginning or end of a punch.



\begin{figure}[h]
\centering
\begin{minipage}{6.0cm}
    \centering
    \subtop[]{\includegraphics[height=0.25\textheight]{fig04/fig02}}
    \label{fig:kinect}
\end{minipage}

\hspace{0.5cm}
\begin{minipage}{6.0cm}
    \centering
    \subtop[]{\includegraphics[height=0.25\textheight]{fig04/fig04}}
    \label{fig:kinect2}
\end{minipage}
\begin{minipage}{3.5cm}
    \centering
    \includegraphics[height=0.15\textheight]{fig04/fig05}
    \label{fig:kinect3}
\end{minipage}
\mycaption[WAT]{(a) Periodic punch signal over time (frame number).(b) Periodic signal with local maxima/minima labelled. (c) Close up of local maxima/minima.}
\end{figure}


Smoothing.
I looked at using differentiation as a means of obtaining the velocity and using that as a sensible measure to mark my punches. This did a good job of smoothing out the curve which would allow me to successfully segment my punches. 


\begin{figure}[h]
    \centering
    \includegraphics[height=0.25\textheight]{fig04/fig03}
    \mycaption[Kinect Device]{Depth of left wrist joint over time}
    \label{fig:kinect}
\end{figure}


\paragraph {Dimensionality Reduction Comparison}
It was important to find a way to successfully reduce my data into a cyclical signal that I could automatically segment. I tested a variety of both linear and non-linear techniques (see design section) and analysed the principal components produced. Despite PCA being an older, simple technique than more modern techniques such as diffusion maps it actually produced the most uniform, cyclical signal for the first component making it an obvious choice.

{\bf Maybe talk about using LTSA here in some way as a second component}




\begin{figure}[h]
\centering
\begin{minipage}{6.0cm}
    \centering
    \subtop[]{\includegraphics[height=0.25\textheight]{fig04/fig08}}
    \label{fig:kinect}
\end{minipage}
\hspace{0.5cm}
\begin{minipage}{6.0cm}
    \centering
    \subtop[]{\includegraphics[height=0.25\textheight]{fig04/fig09}}
    \label{fig:kinect2}
\end{minipage}
\begin{minipage}{6.0cm}
    \centering
    \subtop[]{\includegraphics[height=0.25\textheight]{fig04/fig10}}
    \label{fig:kinect2}
\end{minipage}
\mycaption[WAT]{(a) Comparison of Dimensionality Reduction Techniques. PLotting first and second principal components.}
\end{figure}



Now lets see the first Principal Component (from PCA) for each punch.
TALK about normalisation of data.
Talk about getting better data.

\begin{figure}[h]
    \centering
    \includegraphics[height=0.25\textheight]{fig04/fig10}
    \mycaption[Kinect Device]{Depth of left wrist joint over time}
    \label{fig:kinect}
\end{figure}


\paragraph{Automated Punch Segmentation}
After obtaining a smooth cyclical representation of the Jab



\paragraph{Heuristic Rules}



{\bf Hidden Markov models?}
Chapter 4: Implementation\newline
Chapter 5: Data capture??\newline
Need to make and collect data consent forms to run a study?\newline
Need to gather more data?\newline

\paragraph{Data Format}
I record data from the Kinect in a space separated text file with each line corresponding to one timeframe. The structure of a line is: 
tracking_flag x_0 y_0 z_0 tracking_flag x_1 y_1 z_1 ... tracking_flag x_19 y_19 z_19,
where x_i,y_i,z_i are the x,y,z coordinates representing the position of the ith joint.
Each new line is represented by a very large value that could not represent a Kinect measurement. (e.g. 2000000) 
The tracking_flag is an integer which describes the status of the joint:
Joint not tracked = 0, Joint position inferred = 1, Join position tracked = 2.
If the joint is not tracked the position is set to (-10000, -10000, -10000) and it should not be used.
The position of the camera is (0,0,0).


\begin{center}
    \begin{tabular}{| l | l |}
    \hline
    Joint Number & Joint Name \\ \hline
    0 & NUI_SKELETON_POSITION_HIP_CENTER \\ \hline
    1 & NUI_SKELETON_POSITION_SPINE\\ \hline
    2 & NUI_SKELETON_POSITION_SHOULDER_CENTER\\ \hline
    3 & NUI_SKELETON_POSITION_HEAD\\ \hline
    4 & NUI_SKELETON_POSITION_SHOULDER_LEFT\\ \hline
    5 & NUI_SKELETON_POSITION_ELBOW_LEFT\\ \hline
    6 & NUI_SKELETON_POSITION_WRIST_LEFT\\ \hline
    7 & NUI_SKELETON_POSITION_HAND_LEFT\\ \hline
    8 & NUI_SKELETON_POSITION_SHOULDER_RIGHT\\ \hline
    9 & NUI_SKELETON_POSITION_ELBOW_RIGHT\\ \hline
    10 & NUI_SKELETON_POSITION_WRIST_RIGHT\\ \hline
    11 & NUI_SKELETON_POSITION_HAND_RIGHT\\ \hline
    12 & NUI_SKELETON_POSITION_HIP_LEFT\\ \hline
    13 & NUI_SKELETON_POSITION_KNEE_LEFT\\ \hline
    14 & NUI_SKELETON_POSITION_ANKLE_LEFT\\ \hline
    15 & NUI_SKELETON_POSITION_FOOT_LEFT\\ \hline
    16 & NUI_SKELETON_POSITION_HIP_RIGHT\\ \hline
    17 & NUI_SKELETON_POSITION_KNEE_RIGHT\\ \hline
    18 & NUI_SKELETON_POSITION_ANKLE_RIGHT\\ \hline
    19 & NUI_SKELETON_POSITION_FOOT_RIGHT\\ \hline
    \hline
    \end{tabular}
\end{center}
%=========================================================

\subsection{Comparison Methods}
Each comparison method was evaluated on it's ability to produce useful, smooth and sinusoidal output to aid automatic segmentation. Automatic segmentation is a crucial step in the project since on a larger scale much greater data sets will need to be used and collated from multiple sources. If these can be processed and automatically segmented this will remove any manual work required and make this a truly useful system.

\begin{figure}[h]
    \centering
    \includegraphics[height=0.25\textheight]{fig04/drcomp.pdf}
    \mycaption[Kinect Device]{1st PCA comparison}
    \label{fig:drcomp}
\end{figure}
\begin{figure}[h]
    \centering
    \includegraphics[height=0.25\textheight]{fig04/drcomp2.pdf}
    \mycaption[Kinect Device]{1st PCA comparison}
    \label{fig:drcomp}
\end{figure}

We can see from the first principal component plotted from multiple dimensionality reduction method that PCA does in fact give the most useful results, followed closely by CCA. If we then look at the second principal components we can see that PCA performs second to LTSA but since LTSA performs poorly for the first component it makes PCA the obvious choice.


DTW
After using dynamic time warping I found that there was not enough difference between the various punch signals to give me an effective way at segmentation. Comparing jabs to other jabs yielded similarity values from $0 - 1.589$ with an average difference of $0.499$, comparing jabs to crosses yielded similarity values from $0-2.113$ with the average $0.716$. Therefore there was not enough of a consistent difference score to be able to classify they type of punch using this method.

FFT
 I investigated the possibility of running a fast Fourier transform (FFT) on the raw data as well as each segmented punch that was later obtained from using PCA and my own segmentation algorithm. The range for the coefficients was $0 - (63.030 - 0i)$ with a spread across all of the different types of punches. 
Unfortunately this meant the coefficients obtained in both cases proved to be a poor differentiator between punches due to the coefficients being so variable even within the same punch types.

PCA

Once the data has been successfully segmented into individual punches we can begin to extract features that can be used to train a classifier. Between 12 and 15 evenly spaced samples are taken for each individual punch, depending on the classifier to be used later. Each sample corresponds to a point in time which is used to extract the 3 principal coefficients for each point which results in a $36 - 45$ features for each punch.

Once all the different punch sequences are sampled for each type of punch we can use this data to train a classifier. A multi-class SVM, decision tree, Random Forest and neural network were tested. .............

Results

\subsection{Punch Segmentation Algorithm}
After failing to find a way to automatically segment punches using existing methods It became apparent that a custom algorithm will be needed for this task, which can be broken down into several steps.

\begin{enumerate}[noitemsep]
  \item Perform PCA on raw data.
  \item Smooth the principal coefficients. \textcolor{red}{Rember 1st pc}
  \item Find the local maxima and minima for the punch sequence.
  \item Remove erroneous Minima\/Maxima using heuristic rules.
  \item Take a number of evenly spaced samples from between two maximum points, the length of one punch.
  \item Fetch all PCA components that correspond to the time the samples were taken.
  \item Train classifier on new data.
\end{enumerate}

Each frame representing 20 joint positions is reduced from 60 dimensions to 3 principal components per frame. Next the principal components are smoothed to remove any {\bf wrong minima/maxima} which would prevent the automated segmentation of punches. All remaining maxima are then passed through a set of heuristic rules that checks the location of a maxima point relative to it's neighbourhood points to determine if it is legitimate. The simplest form of this is using the Pythagorean theorem to calculate the distance between a maxima and it's neighbours, if the distance is too small it is clear that one of the points is erroneous and that only one of these will be necessary for segmentation. Likewise if a neighbour is too far away it becomes obvious that one of the maxima is incorrect and needs to be removed.\textcolor{red}{image showing points really far down compared to baseline} Thresholding is also used for each punch, with all maxima below a certain threshold removed since the cyclical signature of the punch guarantees the end of the punch will be approximately close to the end of the last punch.
